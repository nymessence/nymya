// Comprehensive Memory Operations Test Suite
// Extensive testing of all memory operations for edge cases and bugs

import lowlevel
import lowlevel.memory
import crystal

func test_memory_allocation() -> Void {
    crystal.manifest("Testing memory allocation operations...")
    
    // Test basic allocation
    var ptr1 = lowlevel.memory.allocate(64)  // Allocate 64 bytes
    if ptr1.address == 0 {
        crystal.manifest("ERROR: Allocation of 64 bytes failed, returned NULL")
    } else {
        crystal.manifest("✓ Allocation of 64 bytes successful")
    }
    
    // Test allocation of different sizes
    var ptr2 = lowlevel.memory.allocate(1)  // Minimum allocation
    if ptr2.address == 0 {
        crystal.manifest("ERROR: Allocation of 1 byte failed")
    } else {
        crystal.manifest("✓ Allocation of 1 byte successful")
    }
    
    var ptr3 = lowlevel.memory.allocate(1024)  // 1KB allocation
    if ptr3.address == 0 {
        crystal.manifest("ERROR: Allocation of 1024 bytes failed")
    } else {
        crystal.manifest("✓ Allocation of 1024 bytes successful")
    }
    
    // Test deallocation
    lowlevel.memory.deallocate(ptr1)
    crystal.manifest("✓ Deallocated first pointer")
    
    lowlevel.memory.deallocate(ptr2)
    crystal.manifest("✓ Deallocated second pointer")
    
    lowlevel.memory.deallocate(ptr3)
    crystal.manifest("✓ Deallocated third pointer")
    
    crystal.manifest("Memory allocation tests completed!")
}

func test_memory_block() -> Void {
    crystal.manifest("Testing memory block operations...")
    
    // Test memory block creation
    var block1 = lowlevel.memory.MemBlock(128)  // 128-byte block
    crystal.manifest("✓ Created 128-byte memory block")
    
    // Test memory block disposal
    block1.dispose()
    crystal.manifest("✓ Disposed memory block")
    
    // Test memory block with different sizes
    var block2 = lowlevel.memory.MemBlock(1)  // Minimum size
    crystal.manifest("✓ Created 1-byte memory block")
    block2.dispose()
    crystal.manifest("✓ Disposed 1-byte memory block")
    
    var block3 = lowlevel.memory.MemBlock(2048)  // 2KB block
    crystal.manifest("✓ Created 2048-byte memory block")
    block3.dispose()
    crystal.manifest("✓ Disposed 2048-byte memory block")
    
    // Test multiple blocks
    var blocks = []
    for i in range(5) {
        blocks.append(lowlevel.memory.MemBlock(64))
        crystal.manifest("  Created block " + i)
    }
    
    // Dispose all blocks
    for i in range(5) {
        blocks[i].dispose()
        crystal.manifest("  Disposed block " + i)
    }
    
    crystal.manifest("Memory block tests completed!")
}

func test_memory_operations() -> Void {
    crystal.manifest("Testing memory operations (memcpy, memset, etc.)...")
    
    // Test memory set operation
    var ptr1 = lowlevel.memory.allocate(16)
    lowlevel.memory.set(ptr1, 65, 8)  // Set 8 bytes to value 65 ('A')
    crystal.manifest("✓ Set 8 bytes to value 65")
    
    // Test memory copy operation
    var ptr2 = lowlevel.memory.allocate(16)
    lowlevel.memory.set(ptr2, 66, 4)  // Set first 4 bytes to value 66 ('B')
    crystal.manifest("✓ Set 4 bytes in second block to value 66")
    
    lowlevel.memory.copy(ptr1, ptr2, 4)  // Copy 4 bytes from ptr2 to ptr1
    crystal.manifest("✓ Copied 4 bytes from second block to first block")
    
    // Clean up
    lowlevel.memory.deallocate(ptr1)
    lowlevel.memory.deallocate(ptr2)
    crystal.manifest("✓ Cleaned up allocated memory")
    
    crystal.manifest("Memory operations tests completed!")
}

func test_memory_edge_cases() -> Void {
    crystal.manifest("Testing memory operation edge cases...")
    
    // Test memory set with size 0
    var ptr = lowlevel.memory.allocate(16)
    lowlevel.memory.set(ptr, 255, 0)  // Set 0 bytes, should do nothing
    crystal.manifest("✓ Set 0 bytes (no-op)")
    
    // Test memory copy with size 0
    var ptr2 = lowlevel.memory.allocate(16)
    lowlevel.memory.copy(ptr, ptr2, 0)  // Copy 0 bytes, should do nothing
    crystal.manifest("✓ Copy 0 bytes (no-op)")
    
    // Test with same source and destination (should work like memcpy)
    lowlevel.memory.set(ptr, 100, 8)  // Set some values
    lowlevel.memory.copy(ptr, ptr, 4)  // Copy first 4 bytes to first 4 bytes (overlap)
    crystal.manifest("✓ Copy with overlapping source/destination")
    
    // Clean up
    lowlevel.memory.deallocate(ptr)
    lowlevel.memory.deallocate(ptr2)
    crystal.manifest("✓ Cleaned up edge case test memory")
    
    crystal.manifest("Memory edge cases tests completed!")
}

func main() -> Void {
    test_memory_allocation()
    test_memory_block()
    test_memory_operations()
    test_memory_edge_cases()
    
    crystal.manifest("All memory operations tests completed!")
}