#!/usr/bin/env nymyac
// Stress test for generating cellular automata images with various rules
// cellular_automata_test.nym

import image.image_basic
import image.extended
import crystal

func main() -> Void {
    crystal.manifest("ðŸ”¬ Starting Cellular Automata Stress Test")
    crystal.manifest("=" * 60)

    // Generate Rule 2 Cellular Automaton
    crystal.manifest("\nâœ… Generating Rule 2 Cellular Automaton...")
    var rule2_img = generate_cellular_automaton(200, 200, 2, 1, 3)
    image.image_basic.save_image(rule2_img, "cellular_rule2.png")
    
    // Generate Rule 3 Cellular Automaton
    crystal.manifest("\nâœ… Generating Rule 3 Cellular Automaton...")
    var rule3_img = generate_cellular_automaton(200, 200, 3, 1, 3)
    image.image_basic.save_image(rule3_img, "cellular_rule3.png")
    
    // Generate Rule 4 Cellular Automaton
    crystal.manifest("\nâœ… Generating Rule 4 Cellular Automaton...")
    var rule4_img = generate_cellular_automaton(200, 200, 4, 1, 3)
    image.image_basic.save_image(rule4_img, "cellular_rule4.png")
    
    // Generate Rule 5 Cellular Automaton
    crystal.manifest("\nâœ… Generating Rule 5 Cellular Automaton...")
    var rule5_img = generate_cellular_automaton(200, 200, 5, 1, 3)
    image.image_basic.save_image(rule5_img, "cellular_rule5.png")

    // Generate elementary cellular automata for rules 2, 3, 4, 5
    crystal.manifest("\nâœ… Generating Elementary Cellular Automata...")
    var eca_rule2_img = generate_elementary_cellular_automaton(500, 500, 2)
    image.image_basic.save_image(eca_rule2_img, "eca_rule2.png")
    
    var eca_rule3_img = generate_elementary_cellular_automaton(500, 500, 3)
    image.image_basic.save_image(eca_rule3_img, "eca_rule3.png")
    
    var eca_rule4_img = generate_elementary_cellular_automaton(500, 500, 4)
    image.image_basic.save_image(eca_rule4_img, "eca_rule4.png")
    
    var eca_rule5_img = generate_elementary_cellular_automaton(500, 500, 5)
    image.image_basic.save_image(eca_rule5_img, "eca_rule5.png")

    crystal.manifest("\nðŸŽ‰ All cellular automata generation completed!")
    crystal.manifest("=" * 60)
    crystal.manifest("Generated PNG files:")
    crystal.manifest("  - cellular_rule2.png")
    crystal.manifest("  - cellular_rule3.png")
    crystal.manifest("  - cellular_rule4.png")
    crystal.manifest("  - cellular_rule5.png")
    crystal.manifest("  - eca_rule2.png")
    crystal.manifest("  - eca_rule3.png")
    crystal.manifest("  - eca_rule4.png")
    crystal.manifest("  - eca_rule5.png")
}

// Generate a cellular automaton using a general rule
func generate_cellular_automaton(width: Int, height: Int, rule: Int, initial_state: Int = 1, neighbors: Int = 3) -> image.Image {
    var img = image.image_basic.create_image(width, height, 3)
    
    // Initialize first row with random values or a single cell in the middle
    for x in range(0, width) {
        var val = if x == width / 2 { 255 } else { 0 }  // Single active cell in center
        img.set_pixel(x, 0, val, val, val)
    }
    
    // Generate subsequent rows based on the rule
    for y in range(1, height) {
        for x in range(0, width) {
            // Count neighbors
            var neighbor_count = 0
            for nx in range(max(0, x - neighbors), min(width, x + neighbors + 1)) {
                if nx != x {
                    var pixel = img.get_pixel(nx, y - 1)
                    if pixel["r"] > 0 {
                        neighbor_count = neighbor_count + 1
                    }
                }
            }
            
            // Apply rule to determine next state
            var next_state = if (neighbor_count % rule) == 0 { 255 } else { 0 }
            img.set_pixel(x, y, next_state, next_state, next_state)
        }
    }
    
    return img
}

// Generate elementary cellular automaton (1D automaton expanded to 2D for visualization)
func generate_elementary_cellular_automaton(width: Int, height: Int, rule_num: Int) -> image.Image {
    var img = image.image_basic.create_image(width, height, 1)  // Grayscale
    
    // Initialize first row with a single active cell in the center
    img.set_pixel(width / 2, 0, 255, 255, 255)
    
    // Generate subsequent rows based on elementary CA rules
    for y in range(1, height) {
        for x in range(0, width) {
            // Get the three neighbors from the previous row (left, center, right)
            var left = if x == 0 { 0 } else { img.get_pixel(x - 1, y - 1)["r"] }
            var center = img.get_pixel(x, y - 1)["r"]
            var right = if x == width - 1 { 0 } else { img.get_pixel(x + 1, y - 1)["r"] }
            
            // Map the neighborhood to the rule table
            var next_state = next_cell_state(left, center, right, rule_num)
            var color = if next_state { 255 } else { 0 }
            img.set_pixel(x, y, color, color, color)
        }
    }
    
    return img
}

// Determine next cell state based on elementary cellular automaton rules
func next_cell_state(left: Int, center: Int, right: Int, rule: Int) -> Bool {
    // Convert the three-bit neighborhood to an index (0-7)
    var pattern_index = (if left > 0 { 4 } else { 0 }) + 
                        (if center > 0 { 2 } else { 0 }) + 
                        (if right > 0 { 1 } else { 0 })
    
    // Extract bit corresponding to this pattern in the rule number
    var bit_position = rule & (1 << pattern_index)
    
    return bit_position != 0
}

// If this is run as the main script
if lowlevel.os.script_name() == "cellular_automata_test.nym" {
    main()
}