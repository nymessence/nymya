// Response generation with adaptive anti-repetition strategies
// response_generator.nym

import storygen.config
import storygen.context_builder
import storygen.repitition_detector
import storygen.environmental_triggers
import storygen.character_loader
import storygen.api_client
import lowlevel.random

namespace storygen.response_generator

// Ensure defaults are initialized at module load
storygen.config.init_defaults()

func generate_response_adaptive(current: Dict, other: Dict, history: List[Dict], 
                              turn: Int, enable_environmental: Bool = True,
                              similarity_threshold: Float = 0.45, 
                              verbose: Bool = False, scenario_context: String = None,
                              lorebook_entries: List[String] = None) -> String {
    // Detect repetition patterns
    var repetition_data = storygen.repitition_detector.detect_repetition_patterns(history, similarity_threshold)
    var repetition_score = repetition_data.get('repetition_score', 0.0)
    
    if verbose {
        crystal.manifest("ðŸ“Š Repetition score: " + repetition_score.to_string()[:4])
        var issues = repetition_data.get('issues', [])
        if issues.length() > 0 {
            crystal.manifest("âš ï¸  Issues: " + issues[:2].join(", "))
        }
    }
    
    // Extract lorebook entries
    var actual_lorebook_entries = lorebook_entries
    if lorebook_entries == None {
        actual_lorebook_entries = storygen.character_loader.extract_lorebook_entries(
            current.get('raw_data', {}), 
            history[-5:] if history.length() >= 5 else history
        )
    }
    
    // Build context with anti-repetition guidance
    var context_result = storygen.context_builder.build_context_adaptive(
        current, other, history, actual_lorebook_entries, repetition_data, similarity_threshold
    )
    var system_prompt = context_result[0]
    var lorebook_context = context_result[1]
    var history_text = context_result[2]
    
    // Add scenario context and enforce scenario constraints if provided
    if scenario_context {
        // Add scenario context to system prompt
        var scenario_text = "\nCUSTOM SCENARIO CONTEXT:\n" + scenario_context
        system_prompt = system_prompt + scenario_text
    }
    
    // Environmental trigger injection
    var environmental_trigger = ""
    if enable_environmental and turn > 3 and lowlevel.random.random() < 0.15 {
        environmental_trigger = storygen.environmental_triggers.generate_environmental_trigger(
            current, other, current.get('scenario_context', None), history
        )
        if verbose {
            crystal.manifest("ðŸŒªï¸  Environmental trigger: " + environmental_trigger[:50] + "...")
        }
    }
    
    // Build the prompt
    var prompt_parts = [system_prompt]
    
    if lorebook_context.length() > 0 {
        prompt_parts.append("\n### RELEVANT LORE ###\n" + lorebook_context)
    }
    
    prompt_parts.append("\n### CONVERSATION HISTORY ###\n" + history_text)
    
    if environmental_trigger.length() > 0 {
        prompt_parts.append("\n### ENVIRONMENTAL EVENT ###\n" + environmental_trigger)
    }
    
    // Get last message for context
    var last_message = ""
    if history.length() > 0 {
        var last_msg = history[-1]
        if last_msg is Dict and last_msg.contains('content') {
            last_message = last_msg['content']
    }
    
    var model_name = storygen.config.MODEL_NAME or "glm-4.5-flash"
    prompt_parts.append("\n### RESPOND AS " + current['name'].to_upper() + " ###")
    prompt_parts.append("Previous message: " + last_message)
    prompt_parts.append("\nYour response (as " + current['name'] + "):")
    
    var full_prompt = "\n".join(prompt_parts)
    
    // Adjust temperature based on repetition score
    var temperature = 0.7
    if repetition_score > 0.6 {
        temperature = min(0.95, 0.7 + (repetition_score * 0.4))
        if verbose {
            crystal.manifest("ðŸ”¥ Increased temperature to " + temperature.to_string()[:4])
        }
    }
    
    // Make API call
    try {
        var client = storygen.api_client.get_client()
        // In a real implementation, this would call the actual API
        // For now, using the simulation function
        var content = storygen.api_client.simulate_api_call(full_prompt, 350, temperature, [])
        
        // Clean up response
        content = lowlevel.string.replace_all(content, [current['name'] + ":", "[" + current['name'] + "]"], "").strip()
        
        // Emergency validation
        if content.split().length() < 5 {
            if verbose {
                crystal.manifest("âš ï¸  Response too short, triggering emergency response")
            }
            return generate_emergency_response(current, other, history, repetition_data, turn)
        }
        
        return content
        
    } catch e {
        crystal.manifest("âŒ API error in generate_response_adaptive: " + e.to_string())
        return generate_emergency_response(current, other, history, repetition_data, turn)
    }
}

func generate_emergency_response(current: Dict, other: Dict, history: List[Dict],
                                repetition_data: Dict, turn: Int) -> String {
    // Generate emergency fallback response with maximum diversity
    var emergency_templates = [
        "*" + current['name'] + " pauses, their expression shifting as a new thought emerges* Tell me, " + other['name'] + ", what brought you here today?",
        "*" + current['name'] + " recalls a memory* You know, " + other['name'] + ", I once encountered something similar... *trails off thoughtfully*",
        "*" + current['name'] + "'s gaze sharpens with sudden intensity* Wait. There's something you're not telling me, isn't there?",
        "*Unexpectedly changes the subject* Forgive me, but I can't help wondering - what do you truly want from this conversation?",
        "*" + current['name'] + " lets out a quiet laugh* This is strange. I feel like we're circling around something important without saying it directly.",
        "*Leans forward with renewed curiosity* " + other['name'] + ", answer me this: if you could change one thing about your current situation, what would it be?",
        "*" + current['name'] + "'s expression becomes thoughtful* I realize I've been talking without truly listening. What matters most to you in all of this?",
        "*A distant sound draws their attention briefly before refocusing* Sorry, where were we? Actually, never mind that - tell me about yourself. The real you, not what you think I want to hear."
    ]
    
    // Select based on turn number for variety
    var template_index = (turn * 3) % emergency_templates.length()
    var response = emergency_templates[template_index]
    
    // Add environmental element occasionally
    if lowlevel.random.random() < 0.3 {
        var env_additions = [
            " *The atmosphere shifts subtly*",
            " *A chill runs through the air*",
            " *Light filters through differently now*",
            " *Time seems to slow for a moment*"
        ]
        response = response + env_additions[lowlevel.random.random_int(0, env_additions.length()-1)]
    }
    
    return response
}