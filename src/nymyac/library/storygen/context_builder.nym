// Context and system prompt building with anti-repetition integration
// context_builder.nym

import storygen.repitition_detector
import storygen.config
import storygen.utils

namespace storygen.context_builder

// Ensure defaults are initialized at module load
storygen.config.init_defaults()

func generate_system_prompt(character_name: String, persona: String, voice_analysis: Dict, 
                          private_agenda: String, scenario_context: String = None) -> String {
    // Initialize config if needed
    storygen.config.init_defaults()
    
    var formality_desc = storygen.config.FORMALITY_DESC
    var style_desc = storygen.config.STYLE_DESC
    
    var formality_key = voice_analysis.get("formality", "neutral")
    var formality_text = formality_desc.get(formality_key, "balanced in formality")
    
    var style_key = voice_analysis.get("style", "conversational")
    var style_text = style_desc.get(style_key, "versatile in expression")
    
    var scenario_text = ""
    if scenario_context {
        scenario_text = "\nCURRENT SCENARIO:\n" + scenario_context
    }
    
    var characteristics = voice_analysis.get("characteristics", [])
    if characteristics.length() > 0 {
        characteristics = characteristics.join(", ")
    } else {
        characteristics = "authentic personality"
    }
    
    return "You are " + character_name + ", a character with depth and complexity.\n\nCHARACTER CORE:\n\"" + persona[:400] + "\"\n\nVOICE & STYLE:\n- " + formality_text + "\n- " + style_text + "\n- Key traits: " + characteristics + "\n\nPRIVATE MOTIVATION:\n" + private_agenda + scenario_text + "\n\nRESPONSE PRINCIPLES:\n1. PROGRESSION: Every response must advance the conversation or deepen the relationship\n2. SPECIFICITY: React to specific details from the previous message\n3. VOICE CONSISTENCY: Match your character's established voice and style\n4. VARIETY: Vary sentence structure, action descriptions, and emotional expression\n5. SHOW DON'T TELL: Reveal personality through actions, reactions, and specific details\n6. INTERNAL DEPTH: Share genuine thoughts and feelings that align with your character\n7. ENVIRONMENTAL AWARENESS: React to environmental triggers within 1-2 responses\n\nANTI-REPETITION RULES (ABSOLUTE):\n- NEVER repeat the same opening phrases (e.g., \"I lean back\", \"I chuckle softly\")\n- NEVER copy or closely paraphrase the previous speaker's exact words\n- MAXIMUM ONE action/emotional description per response (enclosed in *asterisks*)\n- Vary response length dramatically (mix short 20-word responses with longer 80-word responses)\n- If conversation stalls, introduce completely new elements: memories, observations, questions\n- ALWAYS react to environmental triggers within 2 responses\n- NEVER let your speech patterns be influenced by the other character's style\n- COMPLETE SENTENCES ONLY - no sentence fragments unless for dramatic effect\n\nYou are " + character_name + ". Act, think, and respond as they would. Your character integrity depends on authentic, varied dialogue."
}

func build_context_adaptive(current: Dict, other: Dict, history: List[Dict], 
                          lorebook_entries: List[String] = None, 
                          repetition_data: Dict = None, 
                          similarity_threshold: Float = None) -> List[Any] {
    // Initialize config if needed
    storygen.config.init_defaults()
    
    var threshold = similarity_threshold or storygen.config.DEFAULT_SIMILARITY_THRESHOLD or 0.45
    
    // Generate system prompt if not already present
    var system_prompt = current.get("system_prompt", "")
    if system_prompt == "" {
        system_prompt = generate_system_prompt(
            current["name"],
            current["persona"],
            current["voice_analysis"],
            current["private_agenda"],
            current.get("scenario_context", None)
        )
    }
    
    // Add AGGRESSIVE anti-repetition guidance when needed
    if repetition_data and repetition_data.get("repetition_score", 0) > threshold {
        var anti_repetition_guidance = storygen.repitition_detector.generate_anti_repetition_guidance(
            repetition_data, current["name"], other["name"]
        )
        system_prompt = system_prompt + anti_repetition_guidance
    }
    
    // Build lorebook context safely
    var lorebook_context = ""
    if lorebook_entries and lorebook_entries is List {
        lorebook_context = "\n".join(lorebook_entries[:3])  // Take first 3 entries
        var max_tokens = storygen.config.MAX_LOREBOOK_TOKENS or 8198
        lorebook_context = storygen.utils.truncate_to_tokens(lorebook_context, max_tokens)
    }
    
    // Trim history with AGGRESSIVE pattern removal
    var max_history_tokens = storygen.config.MAX_HISTORY_TOKENS or 12288
    var trimmed_history = storygen.utils.trim_history_adaptive(history, max_history_tokens)
    
    // Build history text with character differentiation
    var history_items = []
    for i, h in enumerate(trimmed_history[-12:]) {  // Take last 12 items
        if h is Dict and h.contains("name") and h.contains("content") {
            history_items.append("[Turn " + (i+1) + "] " + h["name"] + ": " + h["content"])
        }
    }
    var history_text = "\n".join(history_items)
    
    return [system_prompt, lorebook_context, history_text]
}